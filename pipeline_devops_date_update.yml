resources:
  webhooks:
    - webhook: trigger_date # Webhook alias
      connection: incoming_webhook_connection_trigger_date # Incoming webhook service connection

pool:
  name: "Azure Pipelines"

variables:
- group: "devops_boards"

steps:

- task: Bash@3
  inputs:
   workingDirectory: '$(System.DefaultWorkingDirectory)/'
   targetType: 'inline'
   script: |
    printenv
    # Check if requirements are installed
    if [ $(dpkg-query -W -f='${Status}' jq 2>/dev/null | grep -c "ok installed") -eq 0 ];
      image_ok=1
    then
      image_ok=0
      echo "Missing jq"
    fi
    if [ $(dpkg-query -W -f='${Status}' az 2>/dev/null | grep -c "ok installed") -eq 0 ];
      image_ok=1
    then
      image_ok=0
      echo "Missing az client"
    fi
    # Remove special characteres from JSON
    escape_data() {
      local data=$1
      data="${data//$'\n'/''}"
      data="${data//$'\r'/''}"
      data="${data//\\//}"
      echo "$data"
    }
    JsonPost=$(escape_data $'${{ convertToJson(parameters.trigger_date) }}')
    # Create JSON file to be used by bash
    echo ${JsonPost} > JsonPost.json
    cat JsonPost.json

- task: Bash@3
  inputs:
    workingDirectory: '$(System.DefaultWorkingDirectory)/'
    filePath: devops_date_update.sh
  env:
    AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)