resources:
  webhooks:
    - webhook: trigger_date # Webhook alias
      connection: incoming_webhook_connection_trigger_date # Incoming webhook service connection

pool:
  name: "Azure Pipelines"

variables:
- group: "devops_boards"

steps:

- task: Bash@3
  inputs:
   workingDirectory: '$(System.DefaultWorkingDirectory)/'
   targetType: 'inline'
   script: |
    export AZURE_DEVOPS_EXT_PAT=$(AZURE_DEVOPS_EXT_PAT)
    #---------------------
    # Remove special characteres from JSON
    #---------------------    
    escape_data() {
      local data=$1
      data="${data//$'\n'/''}"
      data="${data//$'\r'/''}"
      data="${data//\\//}"
      echo "$data"
    }
    JsonPost=$(escape_data $'${{ convertToJson(parameters.trigger_date) }}')
    # Create JSON file to be used by bash
    echo ${JsonPost} > $(System.DefaultWorkingDirectory)/JsonPost.json
    cat $(System.DefaultWorkingDirectory)/JsonPost.json
    #---------------------
    # Check if it's running on Microsoft Hosted Agent or Self-Hosted Agent
    #---------------------
    # if [ AGENT_NAME != "Hosted Agent" ]; then
    #   echo "Running on Microsoft Hosted Agent"
    #   chmod +x $(System.DefaultWorkingDirectory)/devops_date_update.sh
    #   $(System.DefaultWorkingDirectory)/devops_date_update.sh
    # else
      echo "Running on Self-Hosted Agent"
      if [ $(dpkg-query -W -f='${Status}' docker 2>/dev/null | grep -c "ok installed") -eq 0 ]; then
        echo "Docker installed"
        docker --version
        docker run -it cimg/azure:2023.04.1 -v $(System.DefaultWorkingDirectory):$(System.DefaultWorkingDirectory) "chmod +x $(System.DefaultWorkingDirectory)/devops_date_update.sh; $(System.DefaultWorkingDirectory)/devops_date_update.sh"
      else
        echo "You must install docker on Self-Hosted Agent"
      fi
    # fi

# - task: Bash@3
#   inputs:
#     workingDirectory: '$(System.DefaultWorkingDirectory)/'
#     filePath: devops_date_update.sh
#   env:
#     AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)